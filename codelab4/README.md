# Build and Debug Android CTS
In this code lab, you will learn how to build & debug CTS in this code lab.
Why should you care? tl;dr Android Open-Source Project (AOSP) empowers anyone
to build their flavor of Android devices without asking for permission. But,
a big problem is anyone can mistakenly implement a device, which may break
3rd Android party apps because one can change anything in Android. Therefore,
Android Compatibility Test Suite, [CTS](https://source.android.com/compatibility/overview)
is used to help device developers to validate if a device can run Android apps
properly.

## 1. Build & Run CTS
### 1a. Build
To CTS under the Android source directory, e.g.:
```
cd /ws/android && . build/envsetup.sh && lunch sdk_phone_x86_64-userdebug && make cts -j16
```
### 1b. Run
To run a CTS test module: SignatureTest#testSignature
```
cts-tradefed run cts -m CtsCurrentApiSignatureTestCases -t android.signature.cts.api.SignatureTest#testSignature
```
### 1c. Learn more
To learn more at [CTS Development](https://source.android.com/compatibility/cts/development)
& [Running CTS tests](https://source.android.com/compatibility/cts/run)

## 2. Debug a CTS test case with Android Studio
There are more than a million test cases in CTS. And debugging them can be
very difficult & time-consuming even for seasonal engineers. Android Studio has
a user-friendly GUI to make it easier for app developers. As most CTS test modules
are just a special kind of "app/APK", you can use Android Studio to increase
your productivity on debugging or even rationalizing the code in concern.

### 2a. Typical debug workflow
A typically debug cycle is hypothesizing, adding logs, building, testing &
repeat. When you suspect or need to know more about a piece of code, you can
follow these steps to inspect the execution step by step. For example for
testSignature:

Todo
#### 2a1. Create a project
#### 2a2. Set breakpoints
#### 2a3. Run the test for debugging
#### 2a4. Step through & inspect

### 2b. Another Case Study
This is a real case that an device maker could not figuer out why CTS failed to
collect device information on their AVD. Even though the physical device does
not have the problem. These are the steps to pin pointed the problem.

physical device.
CtsDeviceInfo.apk
CtsDeviceInfo.apk is not a test
1. Make apk debugable

- In ManifestGenerator.java, add the following snippet bellow ```serializer.startTag(ns, APPLICATION);```

  ```
  serializer.attribute(ns, "android:debuggable", "true");
  ```
- Why?
  - If APK is not debugable an error will occor
  - It's manifest is generated by ManifestGenerator.java


2. Build CTS
```
cd /path/to/android/root
make cts -j32 TARGET_PRODUCT=aosp_arm64
cts-tradefed
```
3. Open APK with Android studio
4. Install APK manualy
 ```
 adb install -g /ws/android/out/host/linux-x86/cts/android-cts/testcases/CtsDeviceInfo.apk
 ```
5. Start app and wait for debugger

## 3. Extra Credits
```
adb shell am instrument -e debug true  -w -r --no-isolated-storage   -e newRunListenerMode true -e timeout_msec 300000 com.android.compatibility.common.deviceinfo/androidx.test.runner.AndroidJUnitRunner
```
6. Setup breakpoints in Android Studio
    - In Android studio, click on the line of code that you want the application to stop at
7. Attach debugger to Android Process
    - Top right bug icon, click and select the running app
8. Start debug
    - Execute the app, and wait for the break
9. Check call stack and step through
